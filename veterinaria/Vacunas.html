<!-- MODAL VACUNAS -->
<div id="modalVacunas" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>ğŸ’‰ Registro de Vacunas</h2>
    
    <!-- ğŸ¾ Datos de la Mascota -->
    <section>
      <h3>ğŸ¾ InformaciÃ³n de la Mascota</h3>

      <!-- ID Cliente e ID Mascota ocultos -->
      <input type="hidden" id="idCliente" />
      <input type="hidden" id="idMascota" />

      <label for="nombreMascota">ğŸ¶ Nombre de Mascota:</label>
      <input type="text" id="nombreMascota" placeholder="Firulais, Michi..." onblur="onNombreMascotaChange()" />

      <label for="nombreDueno">ğŸ‘¤ DueÃ±o:</label>
      <input type="text" id="nombreDueno" placeholder="Cargando dueÃ±o..." readonly />

      <label for="especieSelect">ğŸ¦´ Especie:</label>
      <select id="especieSelect" onchange="onEspecieChange()">
        <option value="">Seleccione especie</option>
        <option value="Perro ğŸ•">Perro ğŸ•</option>
        <option value="Gato ğŸˆ">Gato ğŸˆ</option>
        <option value="Conejo ğŸ‡">Conejo ğŸ‡</option>
        <option value="Ave ğŸ¦">Ave ğŸ¦</option>
        <option value="HÃ¡mster ğŸ¹">HÃ¡mster ğŸ¹</option>
        <option value="Tortuga ğŸ¢">Tortuga ğŸ¢</option>
        <option value="Reptil ğŸ¦">Reptil ğŸ¦</option>
        <option value="HurÃ³n ğŸ¦¡">HurÃ³n ğŸ¦¡</option>
        <option value="Caballo ğŸ´">Caballo ğŸ´</option>
        <option value="Cuy ğŸ¹">Cuy ğŸ¹</option>
        <option value="Otro">Otro</option>
      </select>
      <input type="text" id="especieOtro" placeholder="Especifique especie..." style="display:none; margin-top:5px;" />

      <label for="raza">ğŸ¥‡ Raza:</label>
      <select id="raza" onchange="onRazaChange()">
        <option value="">Seleccione especie primero</option>
      </select>
      <input type="text" id="razaOtro" placeholder="Especifique raza..." style="display:none; margin-top:5px;" />

      <label for="edad">ğŸ‚ Edad:</label>
      <input type="number" id="edad" min="0" placeholder="AÃ±os" />

      <label for="sexo">âš§ï¸ Sexo:</label>
      <select id="sexo">
        <option value="Macho">Macho</option>
        <option value="Hembra">Hembra</option>
      </select>

      <label for="peso">âš–ï¸ Peso (kg):</label>
      <input type="number" id="peso" min="0" step="0.1" placeholder="kg" />
    </section>

    <!-- ğŸ’‰ InformaciÃ³n de VacunaciÃ³n -->
    <section>
      <h3>ğŸ§¬ Detalles de VacunaciÃ³n</h3>
      <label for="nombreVacuna">ğŸ§ª Vacuna:</label>
      <select id="nombreVacuna">
        <option value="">Cargando vacunas...</option>
      </select>

      <label for="fechaAplicacion">ğŸ“… Fecha de aplicaciÃ³n:</label>
      <input type="date" id="fechaAplicacion" />

      <label for="fechaRefuerzo">ğŸ” Fecha de refuerzo:</label>
      <input type="date" id="fechaRefuerzo" />

      <label for="veterinario">ğŸ‘¨â€âš•ï¸ Aplicado por:</label>
      <input type="text" id="veterinario" placeholder="Dr. Posh" />

      <label for="observaciones">ğŸ“ Observaciones:</label>
      <textarea id="observaciones" rows="3" placeholder="Ninguna reacciÃ³n, necesita seguimiento..."></textarea>
    </section>

    <!-- ğŸ“‹ Tabla de Vacunas -->
    <section>
      <h3>ğŸ“Š Historial de VacunaciÃ³n</h3>
      <table border="1" id="tablaVacunas">
        <thead>
          <tr>
            <!-- columnas definidas -->
          </tr>
        </thead>
        <tbody>
          <!-- filas dinÃ¡micas -->
        </tbody>
      </table>
    </section>

    <!-- âœ… Acciones -->
    <div class="acciones">
      <button onclick="guardarVacuna()">ğŸ’¾ Guardar Vacuna</button>
      <button onclick="cerrarModal('modalVacunas')">âŒ Cerrar</button>
    </div>
  </div>
</div>

<script>
  // Mapa de especies y razas omitido para brevedad (igual al anterior)

  function onNombreMascotaChange() {
    const nombre = document.getElementById('nombreMascota').value;
    if (!nombre) return;
    // Llamar a servidor para obtener datos de cliente
    google.script.run.withSuccessHandler(data => {
      document.getElementById('idCliente').value = data.idCliente;
      document.getElementById('nombreDueno').value = data.nombreDueno;
      document.getElementById('idMascota').value = data.idMascota;
      // Si data incluye edad, sexo, peso, especie, raza, poblar campos
      if (data.edad) document.getElementById('edad').value = data.edad;
      if (data.sexo) document.getElementById('sexo').value = data.sexo;
      if (data.peso) document.getElementById('peso').value = data.peso;
      if (data.especie) {
        document.getElementById('especieSelect').value = data.especie;
        onEspecieChange();
        document.getElementById('raza').value = data.raza;
      }
    }).obtenerDatosCliente(nombre);
  }

  function guardarVacuna() {
    const payload = {
      idCliente: document.getElementById('idCliente').value,
      idMascota: document.getElementById('idMascota').value,
      nombreMascota: document.getElementById('nombreMascota').value,
      nombreDueno: document.getElementById('nombreDueno').value,
      especie: /* igual lÃ³gica Otro */ '',
      raza: '',
      edad: document.getElementById('edad').value,
      sexo: document.getElementById('sexo').value,
      peso: document.getElementById('peso').value,
      vacuna: document.getElementById('nombreVacuna').value,
      fechaAplicacion: document.getElementById('fechaAplicacion').value,
      fechaRefuerzo: document.getElementById('fechaRefuerzo').value,
      veterinario: document.getElementById('veterinario').value,
      observaciones: document.getElementById('observaciones').value
    };
    google.script.run.withSuccessHandler(res => {
      if (res.success) {
        alert('Vacuna guardada correctamente');
        cerrarModal('modalVacunas');
      } else {
        alert('Error: ' + res.error);
      }
    }).registrarVacuna(payload);
  }
</script>