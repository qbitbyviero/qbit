<!-- Vacunas.html -->
<div id="modalVacunas" class="modal" style="display:none;justify-content:center;align-items:flex-start;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ’‰ Registro de Vacunas 6</h2>
      <span class="close" onclick="cerrarModal('modalVacunas')">&times;</span>
    </div>

    <!-- SelecciÃ³n Existente / Nuevo -->
    <div class="button-row">
      <div><a href="#" id="btnExistente" title="Cliente Existente"></a></div>
      <div><a href="#" id="btnNuevo" title="Nuevo Cliente"></a></div>
    </div>

    <!-- SecciÃ³n Cliente Existente -->
    <div id="seccionExistente" style="display:none;">
      <div class="form-group">
        <label for="selectMascota">ğŸ¾ Seleccione Mascota:</label>
        <select id="selectMascota"></select>
      </div>
      <button class="btn btn-primary" id="cargarDatosClienteBtn">ğŸ’¡ Cargar Datos</button>
    </div>

    <!-- SecciÃ³n Nuevo Cliente -->
    <div id="seccionNuevo" style="display:none;">
      <div class="form-group">
        <label>ğŸ‘¤ Nombre DueÃ±o:</label>
        <input type="text" id="inputNuevoDueno" required/>
      </div>
      <div class="form-group">
        <label>ğŸ  DirecciÃ³n:</label>
        <input type="text" id="inputDireccion" required/>
      </div>
      <div class="form-group">
        <label>ğŸ“ TelÃ©fono:</label>
        <input type="tel" id="inputTelefono" required/>
      </div>
      <div class="form-group">
        <label>âœ‰ï¸ Correo:</label>
        <input type="email" id="inputCorreo" required/>
      </div>
    </div>

    <!-- Datos de la Mascota -->
    <form id="formVacuna" class="modal-form" onsubmit="event.preventDefault(); guardarVacuna();">
      <input type="hidden" id="idCliente"/>
      <input type="hidden" id="idMascota"/>

      <div id="datosMascota" style="display:none;">
        <div class="form-group">
          <label>ğŸ¶ Nombre Mascota:</label>
          <input type="text" id="nombreMascota" required/>
        </div>
        <div class="form-group">
          <label>ğŸ¦´ Especie:</label>
          <input type="text" id="especie" required/>
        </div>
        <div class="form-group">
          <label>ğŸ¥‡ Raza:</label>
          <input type="text" id="raza" required/>
        </div>
        <div class="form-group">
          <label>ğŸ‚ Edad:</label>
          <input type="text" id="edad" placeholder="3 aÃ±os, 11 meses" required/>
        </div>
        <div class="form-group">
          <label>âš§ï¸ Sexo:</label>
          <input type="text" id="sexo" required/>
        </div>
        <div class="form-group">
          <label>âš–ï¸ Peso:</label>
          <input type="text" id="peso" placeholder="5 kg, 250 g" required/>
        </div>
      </div>

      <!-- Detalles de VacunaciÃ³n -->
      <div class="form-group">
        <label>ğŸ§ª Vacuna:</label>
        <select id="nombreVacuna" required>
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label>ğŸ“… Fecha de aplicaciÃ³n:</label>
        <input type="date" id="fechaAplicacion" required/>
      </div>
      <div class="form-group">
        <label>ğŸ” Fecha de refuerzo:</label>
        <input type="date" id="fechaRefuerzo"/>
      </div>
      <div class="form-group">
        <label>ğŸ‘¨â€âš•ï¸ Aplicado por:</label>
        <input type="text" id="veterinario" placeholder="Dr. Posh"/>
      </div>
      <div class="form-group">
        <label>ğŸ“ Observaciones:</label>
        <textarea id="observaciones" rows="3"></textarea>
      </div>

      <!-- Botones -->
      <div class="btn-container">
        <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar Vacuna</button>
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalVacunas')">âŒ Cancelar</button>
      </div>
    </form>

  </div>
</div>

<script>
  // Referencia al backend
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbygeTmeEpPvYaOh3e2loYib8NGrFr9jMIqPPvCEuT3jjh2O62rXRnqfokf8Svso7mgR/exec';

  // Botones flip
  document.getElementById('btnExistente').addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('seccionExistente').style.display = 'block';
    document.getElementById('seccionNuevo').style.display = 'none';
    document.getElementById('datosMascota').style.display = 'none';
    cargarListaMascotas();
  });
  document.getElementById('btnNuevo').addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('seccionNuevo').style.display = 'block';
    document.getElementById('seccionExistente').style.display = 'none';
    document.getElementById('datosMascota').style.display = 'block';
  });

  // Carga lista de mascotas para clientes existentes
  async function cargarListaMascotas() {
    const resp = await fetch(`${WEBAPP_URL}?action=getClientesMascotas`);
    const data = await resp.json();
    const sel = document.getElementById('selectMascota');
    sel.innerHTML = '<option value="">Seleccione mascota</option>';
    data.mascotas.forEach(m => sel.add(new Option(m, m)));
  }

  // Al pulsar "Cargar Datos"
  document.getElementById('cargarDatosClienteBtn').addEventListener('click', async () => {
    const nombre = document.getElementById('selectMascota').value;
    if (!nombre) return alert('Seleccione una mascota');
    const resp = await fetch(`${WEBAPP_URL}?action=getDatosCliente&nombreMascota=${encodeURIComponent(nombre)}`);
    const info = await resp.json();
    // Mostrar secciÃ³n con datos
    document.getElementById('datosMascota').style.display = 'block';
    // IDs ocultos
    document.getElementById('idCliente').value = info.idCliente;
    document.getElementById('idMascota').value = info.idMascota;
    // Campos
    document.getElementById('nombreMascota').value = info.nombreMascota;
    document.getElementById('especie').value = info.especie;
    document.getElementById('raza').value = info.raza;
    // Formatea edad: 3.11 â†’ "3 aÃ±os, 11 meses"
    const [a,m] = info.edad.split('.').map(n=>parseInt(n));
    document.getElementById('edad').value = `${a} aÃ±os, ${m} meses`;
    // Formatea peso: 5.25 â†’ "5 kg, 25 g"
    const [kg,gr] = info.peso.split('.').map(n=>parseInt(n));
    document.getElementById('peso').value = `${kg} kg, ${gr} g`;
    document.getElementById('sexo').value = info.sexo;
  });

  // Cargar vacunas al abrir el modal
  async function cargarVacunasModal() {
    const sel = document.getElementById('nombreVacuna');
    sel.innerHTML = '<option>Cargando...</option>';
    try {
      const res = await fetch(`${WEBAPP_URL}?action=getVacunas`);
      const js = await res.json();
      sel.innerHTML = '<option value="">Seleccione vacuna</option>';
      js.vacunas.forEach(v => {
        const o = document.createElement('option');
        o.value = v.nombre; o.textContent = v.nombre;
        sel.appendChild(o);
      });
    } catch {
      sel.innerHTML = '<option>Error al cargar</option>';
    }
  }

  // Abrir modal desde tu script.js principal
  function abrirModalVacunas() {
    document.getElementById('modalVacunas').style.display = 'flex';
    cargarVacunasModal();
  }

  // Guardar vacuna
  async function guardarVacuna() {
    const form = document.getElementById('formVacuna');
    const data = Object.fromEntries(new FormData(form).entries());
    data.action = 'guardarVacuna';
    // Ajusta datos edad/peso para enviar nÃºmero decimal
    const [aÃ±os,meses] = data.edad.match(/(\d+)/g).map(Number);
    data.edad = parseFloat(`${aÃ±os}.${meses}`);
    const [kg,gr] = data.peso.match(/(\d+)/g).map(Number);
    data.peso = parseFloat(`${kg}.${gr}`);
    try {
      const res = await fetch(WEBAPP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (json.status==='success') {
        Toastify({ text:'âœ… Vacuna registrada', gravity:'top', backgroundColor:'#4CAF50' }).showToast();
        cerrarModal('modalVacunas');
        form.reset();
      } else throw new Error(json.message);
    } catch(e) {
      Toastify({ text:`âŒ ${e.message}`, gravity:'top', backgroundColor:'#F44336' }).showToast();
    }
  }
</script>
