<!-- Vacunas.html -->
<div id="modalVacunas" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>ğŸ’‰ Registro de Vacunas</h2>
    
    <!-- ğŸ¾ Datos de la Mascota -->
    <section class="modal-form">
      <!-- IDs ocultos -->
      <input type="hidden" id="idCliente" />
      <input type="hidden" id="idMascota" />

      <div class="form-group">
        <label for="nombreMascota">ğŸ¶ Nombre de Mascota:</label>
        <input type="text" id="nombreMascota" placeholder="Firulais, Michi..." onblur="onNombreMascotaChange()" />
      </div>

      <div class="form-group">
        <label for="nombreDueno">ğŸ‘¤ DueÃ±o:</label>
        <input type="text" id="nombreDueno" placeholder="Cargando dueÃ±o..." readonly />
      </div>

      <div class="form-group">
        <label for="especieSelect">ğŸ¦´ Especie:</label>
        <select id="especieSelect" onchange="onEspecieChange()">
          <option value="">Seleccione especie</option>
          <option value="ğŸ¶ Perro">ğŸ¶ Perro</option>
          <option value="ğŸ± Gato">ğŸ± Gato</option>
          <option value="ğŸ° Conejo">ğŸ° Conejo</option>
          <option value="ğŸ¦œ Ave">ğŸ¦œ Ave</option>
          <option value="ğŸ¹ HÃ¡mster">ğŸ¹ HÃ¡mster</option>
          <option value="ğŸ¢ Tortuga">ğŸ¢ Tortuga</option>
          <option value="ğŸ¦ Reptil">ğŸ¦ Reptil</option>
          <option value="ğŸ¦¡ HurÃ³n">ğŸ¦¡ HurÃ³n</option>
          <option value="ğŸ´ Caballo">ğŸ´ Caballo</option>
          <option value="ğŸ¹ Cuy">ğŸ¹ Cuy</option>
          <option value="Otro">Otro</option>
        </select>
        <input type="text" id="especieOtro" placeholder="Especifique especie..." style="display:none;" />
      </div>

      <div class="form-group">
        <label for="raza">ğŸ¥‡ Raza:</label>
        <select id="raza" onchange="onRazaChange()">
          <option value="">Seleccione especie primero</option>
        </select>
        <input type="text" id="razaOtro" placeholder="Especifique raza..." style="display:none;" />
      </div>

      <div class="form-group">
        <label for="edad">ğŸ‚ Edad:</label>
        <input type="number" id="edad" min="0" placeholder="AÃ±os" />
      </div>

      <div class="form-group">
        <label for="sexo">âš§ï¸ Sexo:</label>
        <select id="sexo">
          <option value="Macho">Macho</option>
          <option value="Hembra">Hembra</option>
        </select>
      </div>

      <div class="form-group">
        <label for="peso">âš–ï¸ Peso (kg):</label>
        <input type="number" id="peso" min="0" step="0.1" placeholder="kg" />
      </div>
    </section>

    <!-- ğŸ’‰ Detalles de VacunaciÃ³n -->
    <section class="modal-form">
      <div class="form-group">
        <label for="nombreVacuna">ğŸ§ª Vacuna:</label>
        <select id="nombreVacuna">
          <option value="">Cargando vacunas...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="fechaAplicacion">ğŸ“… Fecha de aplicaciÃ³n:</label>
        <input type="date" id="fechaAplicacion" />
      </div>
      <div class="form-group">
        <label for="fechaRefuerzo">ğŸ” Fecha de refuerzo:</label>
        <input type="date" id="fechaRefuerzo" />
      </div>
      <div class="form-group">
        <label for="veterinario">ğŸ‘¨â€âš•ï¸ Aplicado por:</label>
        <input type="text" id="veterinario" placeholder="Dr. Posh" />
      </div>
      <div class="form-group">
        <label for="observaciones">ğŸ“ Observaciones:</label>
        <textarea id="observaciones" rows="3" placeholder="Ninguna reacciÃ³n..."></textarea>
      </div>
    </section>

    <!-- ğŸ“‹ Historial -->
    <section>
      <h3>ğŸ“Š Historial de VacunaciÃ³n</h3>
      <table border="1" id="tablaVacunas">
        <thead>
          <tr>
            <th>Vacuna</th><th>AplicaciÃ³n</th><th>Refuerzo</th><th>Veterinario</th><th>Observaciones</th><th>ğŸ—‘ï¸</th>
          </tr>
        </thead>
        <tbody><!-- dinÃ¡mico --></tbody>
      </table>
    </section>

    <!-- Botones -->
    <div class="btn-container">
      <button class="btn btn-primary" onclick="guardarVacuna()">ğŸ’¾ Guardar Vacuna</button>
      <button class="btn btn-secondary" onclick="cerrarModal('modalVacunas')">âŒ Cerrar</button>
    </div>
  </div>
</div>

<script>
  // Mapa de razas por especie (coincide con tu script.js)
  const razasPorEspecie = {
    'ğŸ¶ Perro': ['Labrador ğŸ¶','Pug ğŸ˜›','Chihuahua ğŸ’…','Pitbull ğŸ’ª'],
    'ğŸ± Gato': ['Persa ğŸ˜½','Siames ğŸ˜¸','Sphynx ğŸ±','Maine Coon ğŸ§¶'],
    'ğŸ° Conejo': ['Cabeza de leÃ³n ğŸ¦','Mini Lop ğŸ°','Angora âœ¨'],
    'ğŸ¦œ Ave': ['Periquito ğŸ¦','CacatÃºa ğŸµ','Loro ğŸ’š'],
    'ğŸ¹ HÃ¡mster': ['Sirio ğŸ§¡','Ruso â„ï¸','Roborovski âš¡'],
    'ğŸ¢ Tortuga': ['Orejas rojas ğŸ¢','Rusa ğŸŒ¿'],
    'ğŸ¦ Reptil': ['Iguana ğŸ¦','Gecko ğŸŠ','CamaleÃ³n ğŸŒˆ'],
    'ğŸ¦¡ HurÃ³n': ['Albino ğŸ¤','Mestizo ğŸ–¤'],
    'ğŸ´ Caballo': ['Pura Sangre ğŸ‡','Clydesdale ğŸ'],
    'ğŸ¹ Cuy': ['Peruano ğŸª¶','Abyssinian ğŸµï¸']
  };

  // 1. Al salir del nombre de mascota, obtenemos datos de cliente
  async function onNombreMascotaChange() {
    const nombre = document.getElementById('nombreMascota').value.trim();
    if (!nombre) return;
    const res = await fetch(`${WEBAPP_URL}?action=verificarMascota&nombreMascota=${encodeURIComponent(nombre)}`);
    const info = await res.json();
    if (info.encontrado) {
      // Si existe mascota, pedimos datos completos
      const full = await fetch(`${WEBAPP_URL}?action=getDatosCliente&nombreMascota=${encodeURIComponent(nombre)}`);
      const data = await full.json();
      document.getElementById('idCliente').value = data.idCliente;
      document.getElementById('nombreDueno').value = data.nombreDueno;
      document.getElementById('idMascota').value = data.idMascota;
      if (data.edad) document.getElementById('edad').value = data.edad;
      if (data.sexo) document.getElementById('sexo').value = data.sexo;
      if (data.peso) document.getElementById('peso').value = data.peso;
      if (data.especie) {
        document.getElementById('especieSelect').value = data.especie;
        onEspecieChange();
        document.getElementById('raza').value = data.raza;
      }
    } else {
      // Nuevo registro: limpiamos propietarios previos
      document.getElementById('idCliente').value = '';
      document.getElementById('nombreDueno').value = '';
      document.getElementById('idMascota').value = '';
    }
  }

  // 2. SelecciÃ³n de especie â†’ llenar razas + â€œOtroâ€
  function onEspecieChange() {
    const esp = document.getElementById('especieSelect').value;
    document.getElementById('especieOtro').style.display = esp==='Otro'?'block':'none';

    const razaSel = document.getElementById('raza');
    razaSel.innerHTML = '<option value="">Seleccione raza</option>';
    (razasPorEspecie[esp]||[]).forEach(r=>{
      const o=document.createElement('option'); o.value=r; o.textContent=r;
      razaSel.appendChild(o);
    });
    const oOtro = document.createElement('option');
    oOtro.value='Otro'; oOtro.textContent='Otro';
    razaSel.appendChild(oOtro);
    document.getElementById('razaOtro').style.display='none';
  }

  // 3. Si eligen â€œOtroâ€ raza, mostrar campo manual
  function onRazaChange() {
    const val = document.getElementById('raza').value;
    document.getElementById('razaOtro').style.display = val==='Otro'?'block':'none';
  }

  // 4. Cargar lista de vacunas
  async function cargarListaVacunas() {
    const sel = document.getElementById('nombreVacuna');
    sel.innerHTML = '<option value="">Cargando...</option>';
    try {
      const resp = await fetch(`${WEBAPP_URL}?action=getVacunas`);
      const js = await resp.json();
      sel.innerHTML = '<option value="">Seleccione vacuna</option>';
      js.vacunas.forEach(v=>{
        const o=document.createElement('option');
        o.value=v.nombre; o.textContent=v.nombre;
        sel.appendChild(o);
      });
    } catch {
      sel.innerHTML = '<option value="">Error al cargar</option>';
    }
  }

  // 5. Guardar vacuna
  async function guardarVacuna() {
    const btn = document.querySelector('#modalVacunas button.btn-primary');
    btn.disabled = true; btn.textContent = 'â³ Guardando...';

    // Preparamos datos
    const data = {
      action: 'guardarVacuna',
      idCliente: document.getElementById('idCliente').value,
      idMascota: document.getElementById('idMascota').value,
      nombreMascota: document.getElementById('nombreMascota').value.trim(),
      nombreDueno: document.getElementById('nombreDueno').value.trim(),
      especie: document.getElementById('especieSelect').value==='Otro'
        ? document.getElementById('especieOtro').value.trim()
        : document.getElementById('especieSelect').value,
      raza: document.getElementById('raza').value==='Otro'
        ? document.getElementById('razaOtro').value.trim()
        : document.getElementById('raza').value,
      edad: document.getElementById('edad').value,
      sexo: document.getElementById('sexo').value,
      peso: document.getElementById('peso').value,
      vacuna: document.getElementById('nombreVacuna').value,
      fechaAplicacion: document.getElementById('fechaAplicacion').value,
      fechaRefuerzo: document.getElementById('fechaRefuerzo').value,
      veterinario: document.getElementById('veterinario').value.trim(),
      observaciones: document.getElementById('observaciones').value.trim()
    };

    try {
      const resp = await fetch(WEBAPP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const res = await resp.json();
      if (res.status==='success') {
        mostrarAlerta('âœ… Vacuna registrada', 'success');
        document.getElementById('formVacuna')?.reset();
        cerrarModal('modalVacunas');
      } else {
        throw new Error(res.message||'Error servidor');
      }
    } catch (e) {
      mostrarAlerta(`âŒ ${e.message}`, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ’¾ Guardar Vacuna';
    }
  }

  // 6. Al abrir modal, inicializamos
  function abrirModalVacunas() {
    cargarListaVacunas();
    onEspecieChange();
  }

  // Llamada inicial de funciones al cargar HTML 
  document.addEventListener('DOMContentLoaded', () => {
    // sobreescribimos la apertura si es dinÃ¡mico:
    document.querySelectorAll('a[href$="Vacunas.html"]').forEach(link => {
      link.addEventListener('click', e => {
        abrirModal('modalVacunas');
        abrirModalVacunas();
        e.preventDefault();
      });
    });
  });
</script>