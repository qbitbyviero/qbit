<!-- MODAL VACUNAS -->
<div id="modalVacunas" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>ğŸ’‰ Registro de Vacunas</h2>
    
    <!-- ğŸ¾ Datos de la Mascota -->
    <section>
      <h3>ğŸ¾ InformaciÃ³n de la Mascota</h3>
      
      <!-- Campo DueÃ±o -->
      <label for="nombreDueno">ğŸ‘¤ DueÃ±o:</label>
      <input type="text" id="nombreDueno" placeholder="Cargando dueÃ±o..." readonly />

      <label for="nombreMascota">ğŸ¶ Nombre de Mascota:</label>
      <input type="text" id="nombreMascota" placeholder="Firulais, Michi..." />

      <label for="especieSelect">ğŸ¦´ Especie:</label>
      <select id="especieSelect" onchange="onEspecieChange()">
        <option value="">Seleccione especie</option>
        <option value="Perro ğŸ•">Perro ğŸ•</option>
        <option value="Gato ğŸˆ">Gato ğŸˆ</option>
        <option value="Conejo ğŸ‡">Conejo ğŸ‡</option>
        <option value="Ave ğŸ¦">Ave ğŸ¦</option>
        <option value="HÃ¡mster ğŸ¹">HÃ¡mster ğŸ¹</option>
        <option value="Tortuga ğŸ¢">Tortuga ğŸ¢</option>
        <option value="Reptil ğŸ¦">Reptil ğŸ¦</option>
        <option value="HurÃ³n ğŸ¦¡">HurÃ³n ğŸ¦¡</option>
        <option value="Caballo ğŸ´">Caballo ğŸ´</option>
        <option value="Cuy ğŸ¹">Cuy ğŸ¹</option>
        <option value="Otro">Otro</option>
      </select>
      <input type="text" id="especieOtro" placeholder="Especifique especie..." style="display:none; margin-top:5px;" />

      <label for="raza">ğŸ¥‡ Raza:</label>
      <select id="raza" onchange="onRazaChange()">
        <option value="">Seleccione especie primero</option>
      </select>
      <input type="text" id="razaOtro" placeholder="Especifique raza..." style="display:none; margin-top:5px;" />

      <label for="edad">ğŸ‚ Edad:</label>
      <input type="number" id="edad" min="0" placeholder="AÃ±os" />

      <label for="sexo">âš§ï¸ Sexo:</label>
      <select id="sexo">
        <option value="Macho">Macho</option>
        <option value="Hembra">Hembra</option>
      </select>

      <label for="peso">âš–ï¸ Peso (kg):</label>
      <input type="number" id="peso" min="0" step="0.1" placeholder="kg" />
    </section>

    <!-- ğŸ’‰ InformaciÃ³n de VacunaciÃ³n -->
    <section>
      <h3>ğŸ§¬ Detalles de VacunaciÃ³n</h3>
      <label for="nombreVacuna">ğŸ§ª Vacuna:</label>
      <select id="nombreVacuna">
        <option value="">Cargando vacunas...</option>
      </select>

      <label for="fechaAplicacion">ğŸ“… Fecha de aplicaciÃ³n:</label>
      <input type="date" id="fechaAplicacion" />

      <label for="fechaRefuerzo">ğŸ” Fecha de refuerzo:</label>
      <input type="date" id="fechaRefuerzo" />

      <label for="veterinario">ğŸ‘¨â€âš•ï¸ Aplicado por:</label>
      <input type="text" id="veterinario" placeholder="Dr. Posh" />

      <label for="observaciones">ğŸ“ Observaciones:</label>
      <textarea id="observaciones" rows="3" placeholder="Ninguna reacciÃ³n, necesita seguimiento..."></textarea>
    </section>

    <!-- ğŸ“‹ Tabla de Vacunas -->
    <section>
      <h3>ğŸ“Š Historial de VacunaciÃ³n</h3>
      <table border="1" id="tablaVacunas">
        <thead>
          <tr>
            <th>ID Cliente</th>
            <th>DueÃ±o</th>
            <th>ID Mascota</th>
            <th>Nombre Mascota</th>
            <th>Edad</th>
            <th>Sexo</th>
            <th>Peso</th>
            <th>Especie</th>
            <th>Raza</th>
            <th>Vacuna</th>
            <th>AplicaciÃ³n</th>
            <th>Refuerzo</th>
            <th>Veterinario</th>
            <th>Observaciones</th>
            <th>ğŸ—‘ï¸</th>
          </tr>
        </thead>
        <tbody>
          <!-- AquÃ­ se agregan las filas con JS -->
        </tbody>
      </table>
    </section>

    <!-- âœ… Acciones -->
    <div class="acciones">
      <button onclick="guardarVacuna()">ğŸ’¾ Guardar Vacuna</button>
      <button onclick="cerrarModal('modalVacunas')">âŒ Cerrar</button>
    </div>
  </div>
</div>

<script>
  const razasPorEspecie = {
    'Perro ğŸ•': ['Labrador ğŸ¦®', 'Beagle ğŸ¶', 'Bulldog FrancÃ©s ğŸ•â€ğŸ¦º', 'Poodle ğŸ©', 'Chihuahua ğŸ•', 'Husky ğŸº'],
    'Gato ğŸˆ': ['Siames ğŸ˜º', 'Persa ğŸ±', 'Maine Coon ğŸ¦', 'Bengala ğŸ¯', 'Sphynx ğŸˆâ€â¬›', 'Ragdoll ğŸ’¤'],
    'Conejo ğŸ‡': ['Enano ğŸ°', 'Angora ğŸ§¶', 'Rex ğŸ¦', 'Mini Lop ğŸˆ'],
    'Ave ğŸ¦': ['Canario ğŸ¶', 'Perico ğŸ¦œ', 'CacatÃºa ğŸ¦¤', 'Loro ğŸ¦œ'],
    'HÃ¡mster ğŸ¹': ['Siberiano â„ï¸', 'Ruso ğŸŒ¾', 'Campbell ğŸï¸'],
    'Tortuga ğŸ¢': ['Sulcata ğŸŒ', 'Rusa â„ï¸', 'Caja ğŸ'],
    'Reptil ğŸ¦': ['Iguana ğŸŒ¿', 'CamaleÃ³n ğŸŒˆ', 'Gecko ğŸ¦'],
    'HurÃ³n ğŸ¦¡': ['Albino ğŸ¤', 'Mestizo ğŸ–¤'],
    'Caballo ğŸ´': ['Pura Sangre ğŸ‡', 'Clydesdale ğŸ'],
    'Cuy ğŸ¹': ['Peruano ğŸª¶', 'Abyssinian ğŸµï¸']
  };

  function onEspecieChange() {
    const selEsp = document.getElementById('especieSelect');
    const txtEspOtro = document.getElementById('especieOtro');
    const selRaza = document.getElementById('raza');

    // Mostrar/Ocultar campo Otro especie
    txtEspOtro.style.display = selEsp.value === 'Otro' ? 'block' : 'none';

    // Poblar razas
    const lista = razasPorEspecie[selEsp.value] || [];
    selRaza.innerHTML = '<option value="">Seleccione raza</option>';
    lista.forEach(r => {
      const opt = document.createElement('option'); opt.value = r; opt.textContent = r;
      selRaza.appendChild(opt);
    });
    // opciÃ³n Otro para raza
    const optOtro = document.createElement('option'); optOtro.value = 'Otro'; optOtro.textContent = 'Otro';
    selRaza.appendChild(optOtro);
    document.getElementById('razaOtro').style.display = 'none';
  }

  function onRazaChange() {
    const selR = document.getElementById('raza');
    document.getElementById('razaOtro').style.display = selR.value === 'Otro' ? 'block' : 'none';
  }

  function abrirModalVacunas() {
    document.getElementById('modalVacunas').style.display = 'block';
    // cargar dueÃ±o
    google.script.run.withSuccessHandler(nombre => {
      document.getElementById('nombreDueno').value = nombre;
    }).obtenerNombreDueno();
  }

  function cerrarModal(id) {
    document.getElementById(id).style.display = 'none';
  }

  function guardarVacuna() {
    const data = {};
    data.nombreMascota = document.getElementById('nombreMascota').value;
    data.especie = document.getElementById('especieSelect').value === 'Otro' ? document.getElementById('especieOtro').value : document.getElementById('especieSelect').value;
    data.raza = document.getElementById('raza').value === 'Otro' ? document.getElementById('razaOtro').value : document.getElementById('raza').value;
    data.edad = document.getElementById('edad').value;
    data.sexo = document.getElementById('sexo').value;
    data.peso = document.getElementById('peso').value;
    data.vacuna = document.getElementById('nombreVacuna').value;
    data.fechaAplicacion = document.getElementById('fechaAplicacion').value;
    data.fechaRefuerzo = document.getElementById('fechaRefuerzo').value;
    data.veterinario = document.getElementById('veterinario').value;
    data.observaciones = document.getElementById('observaciones').value;

    // Llamar Apps Script para procesar y guardar en hoja "VacunaciÃ³n"
    google.script.run.withSuccessHandler(res => {
      if(res.success) {
        alert('Vacuna registrada correctamente');
        cerrarModal('modalVacunas');
        // refrescar tabla o recargar pÃ¡gina
      } else {
        alert('Error: ' + res.error);
      }
    }).registrarVacuna(data);
  }
</script>

<!-- SERVER-SIDE APPS SCRIPT -->
<script>
  /**
   * Registrar vacuna en la hoja "VacunaciÃ³n".
   * data: objeto con campos definidos.
   */
  function registrarVacuna(data) {
    try {
      const ss = SpreadsheetApp.openByUrl('https://docs.google.com/spreadsheets/d/1yhLJEUygzZVHP_1tIMJti0OLywLTfmvl0kt1ARVY7Bc/edit?gid=634746177#gid=634746177');
      const sheetCli = ss.getSheetByName('Clientes');
      const sheetVac = ss.getSheetByName('VacunaciÃ³n');
      const clientes = sheetCli.getRange('A2:G' + sheetCli.getLastRow()).getValues();
      let idCliente = '';
      let nombreDueno = '';
      let idMascota = '';
      
      // Buscar cliente por nombreMascota en col G
      clientes.forEach(row => {
        if(row[6] === data.nombreMascota) {
          idCliente = row[0];       // Col A
          nombreDueno = row[1];     // Col B
          idMascota = row[5];       // Col F
        }
      });
      
      // Si no existe, idCliente y idMascota quedarÃ¡n vacÃ­os y se usan datos nuevos
      const nuevaFila = [
        idCliente,
        nombreDueno,
        idMascota,
        data.nombreMascota,
        data.edad || '',
        data.sexo || '',
        data.peso || '',
        data.especie,
        data.raza,
        data.vacuna,
        data.fechaAplicacion,
        data.fechaRefuerzo,
        data.veterinario,
        data.observaciones
      ];
      sheetVac.appendRow(nuevaFila);
      return { success: true };
    } catch(e) {
      return { success: false, error: e.message };
    }
  }
</script>
