<!-- Vacunas.html -->
<div id="modalVacunas" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">💉 Registro de Vacunas 2</h2>
      <span class="close" onclick="cerrarModal('modalVacunas')">&times;</span>
    </div>

    <!-- 🐾 Datos de la Mascota -->
    <form id="formVacuna" class="modal-form" onsubmit="event.preventDefault(); guardarVacuna();">
      <input type="hidden" id="idCliente" />
      <input type="hidden" id="idMascota" />

      <div class="form-group">
        <label for="nombreMascota">🐶 Nombre de Mascota:</label>
        <input type="text" id="nombreMascota" placeholder="Firulais, Michi..." onblur="onNombreMascotaChange()" required />
      </div>

      <div class="form-group">
        <label for="nombreDueno">👤 Dueño:</label>
        <input type="text" id="nombreDueno" placeholder="Cargando dueño..." readonly />
      </div>

      <div class="form-group">
        <label for="especieSelect">🦴 Especie:</label>
        <select id="especieSelect" onchange="onEspecieChange()" required>
          <option value="">Seleccione especie</option>
          <option value="🐶 Perro">🐶 Perro</option>
          <option value="🐱 Gato">🐱 Gato</option>
          <option value="🐰 Conejo">🐰 Conejo</option>
          <option value="🦜 Ave">🦜 Ave</option>
          <option value="🐹 Hámster">🐹 Hámster</option>
          <option value="🐢 Tortuga">🐢 Tortuga</option>
          <option value="🦎 Reptil">🦎 Reptil</option>
          <option value="🦡 Hurón">🦡 Hurón</option>
          <option value="🐴 Caballo">🐴 Caballo</option>
          <option value="🐹 Cuy">🐹 Cuy</option>
          <option value="Otro">Otro</option>
        </select>
        <input type="text" id="especieOtro" placeholder="Especifique especie..." style="display:none;" />
      </div>

      <div class="form-group">
        <label for="raza">🥇 Raza:</label>
        <select id="raza" onchange="onRazaChange()" required>
          <option value="">Seleccione especie primero</option>
        </select>
        <input type="text" id="razaOtro" placeholder="Especifique raza..." style="display:none;" />
      </div>

      <div class="form-group">
        <label for="edad">🎂 Edad:</label>
        <input type="number" id="edad" min="0" placeholder="Años" />
      </div>

      <div class="form-group">
        <label for="sexo">⚧️ Sexo:</label>
        <select id="sexo">
          <option value="Macho">Macho</option>
          <option value="Hembra">Hembra</option>
        </select>
      </div>

      <div class="form-group">
        <label for="peso">⚖️ Peso (kg):</label>
        <input type="number" id="peso" min="0" step="0.1" placeholder="kg" />
      </div>

      <!-- 💉 Detalles de Vacunación -->
      <div class="form-group">
        <label for="nombreVacuna">🧪 Vacuna:</label>
        <select id="nombreVacuna" required>
          <option value="">Cargando vacunas...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="fechaAplicacion">📅 Fecha de aplicación:</label>
        <input type="date" id="fechaAplicacion" required />
      </div>

      <div class="form-group">
        <label for="fechaRefuerzo">🔁 Fecha de refuerzo:</label>
        <input type="date" id="fechaRefuerzo" />
      </div>

      <div class="form-group">
        <label for="veterinario">👨‍⚕️ Aplicado por:</label>
        <input type="text" id="veterinario" placeholder="Dr. Posh" />
      </div>

      <div class="form-group">
        <label for="observaciones">📝 Observaciones:</label>
        <textarea id="observaciones" rows="3" placeholder="Ninguna reacción..."></textarea>
      </div>

      <!-- Botones -->
      <div class="btn-container">
        <button type="submit" class="btn btn-primary">💾 Guardar Vacuna</button>
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalVacunas')">❌ Cerrar</button>
      </div>
    </form>

    <!-- 📋 Historial -->
    <section>
      <h3>📊 Historial de Vacunación</h3>
      <table id="tablaVacunas">
        <thead>
          <tr>
            <th>Vacuna</th><th>Aplicación</th><th>Refuerzo</th><th>Veterinario</th><th>Observaciones</th><th>🗑️</th>
          </tr>
        </thead>
        <tbody><!-- dinámico --></tbody>
      </table>
    </section>
  </div>
</div>

<script>
  const razasPorEspecie = {
    '🐶 Perro': ['Labrador 🐶','Pug 😛','Chihuahua 💅','Pitbull 💪'],
    '🐱 Gato': ['Persa 😽','Siames 😸','Sphynx 🐱','Maine Coon 🧶'],
    '🐰 Conejo': ['Cabeza de león 🦁','Mini Lop 🐰','Angora ✨'],
    '🦜 Ave': ['Periquito 🐦','Cacatúa 🎵','Loro 💚'],
    '🐹 Hámster': ['Sirio 🧡','Ruso ❄️','Roborovski ⚡'],
    '🐢 Tortuga': ['Orejas rojas 🐢','Rusa 🌿'],
    '🦎 Reptil': ['Iguana 🦎','Gecko 🐊','Camaleón 🌈'],
    '🦡 Hurón': ['Albino 🤍','Mestizo 🖤'],
    '🐴 Caballo': ['Pura Sangre 🏇','Clydesdale 🐎'],
    '🐹 Cuy': ['Peruano 🪶','Abyssinian 🏵️']
  };

  function abrirModalVacunas() {
    document.getElementById('modalVacunas').style.display = 'flex';
    cargarListaVacunas();
    onEspecieChange();
    cargarHistorial();
  }

  function cerrarModal(id) {
    document.getElementById(id).style.display = 'none';
    document.getElementById('formVacuna').reset();
    document.getElementById('raza').innerHTML = '<option>Seleccione especie primero</option>';
  }

  function onNombreMascotaChange() {
    const nombre = document.getElementById('nombreMascota').value.trim();
    if (!nombre) return;
    google.script.run.withSuccessHandler(info => {
      if (info.encontrado) {
        Object.assign(document.querySelector('#formVacuna'), {});
        document.getElementById('idCliente').value   = info.idCliente;
        document.getElementById('nombreDueno').value = info.nombreDueno;
        document.getElementById('idMascota').value   = info.idMascota;
        document.getElementById('edad').value        = info.edad;
        document.getElementById('sexo').value        = info.sexo;
        document.getElementById('peso').value        = info.peso;
        document.getElementById('especieSelect').value = info.especie;
        onEspecieChange();
        document.getElementById('raza').value = info.raza;
      } else {
        document.getElementById('nombreDueno').value = '';
      }
    }).verificarMascota(nombre);
  }

  function onEspecieChange() {
    const esp = document.getElementById('especieSelect').value;
    document.getElementById('especieOtro').style.display = esp==='Otro'?'block':'none';
    const sel = document.getElementById('raza');
    sel.innerHTML = '<option>Seleccione raza</option>';
    (razasPorEspecie[esp]||[]).forEach(r=> sel.add(new Option(r,r)));
    sel.add(new Option('Otro','Otro'));
    document.getElementById('razaOtro').style.display='none';
  }

  function onRazaChange() {
    document.getElementById('razaOtro').style.display =
      document.getElementById('raza').value==='Otro'?'block':'none';
  }

  function cargarListaVacunas() {
    const sel = document.getElementById('nombreVacuna');
    sel.innerHTML = '<option>Cargando...</option>';
    google.script.run.withSuccessHandler(vacs => {
      sel.innerHTML = '<option>Seleccione vacuna</option>';
      vacs.forEach(v => sel.add(new Option(v.nombre, v.nombre)));
    }).getVacunas();
  }

  function cargarHistorial() {
    // Implementa si tienes función que trae el historial
  }

  function guardarVacuna() {
    const data = Object.fromEntries(new FormData(document.getElementById('formVacuna')).entries());
    data.action = 'guardarVacuna';
    google.script.run.withSuccessHandler(resp => {
      if (resp.status==='success') {
        Toastify({ text: '✅ Guardado', gravity: 'top', backgroundColor: '#4caf50' }).showToast();
        cerrarModal('modalVacunas');
      } else {
        Toastify({ text: '❌ '+resp.message, gravity: 'top', backgroundColor: '#e74c3c' }).showToast();
      }
    }).guardarVacuna(data);
  }
</script>
