<!-- Vacunas.html -->
<div id="modalVacunas" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ’‰ Registro de Vacunas 2</h2>
      <span class="close" onclick="cerrarModal('modalVacunas')">&times;</span>
    </div>

    <!-- ğŸ¾ Datos de la Mascota -->
    <form id="formVacuna" class="modal-form" onsubmit="event.preventDefault(); guardarVacuna();">
      <input type="hidden" id="idCliente" />
      <input type="hidden" id="idMascota" />

      <div class="form-group">
        <label for="nombreMascota">ğŸ¶ Nombre de Mascota:</label>
        <input type="text" id="nombreMascota" placeholder="Firulais, Michi..." onblur="onNombreMascotaChange()" required />
      </div>

      <div class="form-group">
        <label for="nombreDueno">ğŸ‘¤ DueÃ±o:</label>
        <input type="text" id="nombreDueno" placeholder="Cargando dueÃ±o..." readonly />
      </div>

      <div class="form-group">
        <label for="especieSelect">ğŸ¦´ Especie:</label>
        <select id="especieSelect" onchange="onEspecieChange()" required>
          <option value="">Seleccione especie</option>
          <option value="ğŸ¶ Perro">ğŸ¶ Perro</option>
          <option value="ğŸ± Gato">ğŸ± Gato</option>
          <option value="ğŸ° Conejo">ğŸ° Conejo</option>
          <option value="ğŸ¦œ Ave">ğŸ¦œ Ave</option>
          <option value="ğŸ¹ HÃ¡mster">ğŸ¹ HÃ¡mster</option>
          <option value="ğŸ¢ Tortuga">ğŸ¢ Tortuga</option>
          <option value="ğŸ¦ Reptil">ğŸ¦ Reptil</option>
          <option value="ğŸ¦¡ HurÃ³n">ğŸ¦¡ HurÃ³n</option>
          <option value="ğŸ´ Caballo">ğŸ´ Caballo</option>
          <option value="ğŸ¹ Cuy">ğŸ¹ Cuy</option>
          <option value="Otro">Otro</option>
        </select>
        <input type="text" id="especieOtro" placeholder="Especifique especie..." style="display:none;" />
      </div>

      <div class="form-group">
        <label for="raza">ğŸ¥‡ Raza:</label>
        <select id="raza" onchange="onRazaChange()" required>
          <option value="">Seleccione especie primero</option>
        </select>
        <input type="text" id="razaOtro" placeholder="Especifique raza..." style="display:none;" />
      </div>

      <div class="form-group">
        <label for="edad">ğŸ‚ Edad:</label>
        <input type="number" id="edad" min="0" placeholder="AÃ±os" />
      </div>

      <div class="form-group">
        <label for="sexo">âš§ï¸ Sexo:</label>
        <select id="sexo">
          <option value="Macho">Macho</option>
          <option value="Hembra">Hembra</option>
        </select>
      </div>

      <div class="form-group">
        <label for="peso">âš–ï¸ Peso (kg):</label>
        <input type="number" id="peso" min="0" step="0.1" placeholder="kg" />
      </div>

      <!-- ğŸ’‰ Detalles de VacunaciÃ³n -->
      <div class="form-group">
        <label for="nombreVacuna">ğŸ§ª Vacuna:</label>
        <select id="nombreVacuna" required>
          <option value="">Cargando vacunas...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="fechaAplicacion">ğŸ“… Fecha de aplicaciÃ³n:</label>
        <input type="date" id="fechaAplicacion" required />
      </div>

      <div class="form-group">
        <label for="fechaRefuerzo">ğŸ” Fecha de refuerzo:</label>
        <input type="date" id="fechaRefuerzo" />
      </div>

      <div class="form-group">
        <label for="veterinario">ğŸ‘¨â€âš•ï¸ Aplicado por:</label>
        <input type="text" id="veterinario" placeholder="Dr. Posh" />
      </div>

      <div class="form-group">
        <label for="observaciones">ğŸ“ Observaciones:</label>
        <textarea id="observaciones" rows="3" placeholder="Ninguna reacciÃ³n..."></textarea>
      </div>

      <!-- Botones -->
      <div class="btn-container">
        <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar Vacuna</button>
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalVacunas')">âŒ Cerrar</button>
      </div>
    </form>

    <!-- ğŸ“‹ Historial -->
    <section>
      <h3>ğŸ“Š Historial de VacunaciÃ³n</h3>
      <table id="tablaVacunas">
        <thead>
          <tr>
            <th>Vacuna</th><th>AplicaciÃ³n</th><th>Refuerzo</th><th>Veterinario</th><th>Observaciones</th><th>ğŸ—‘ï¸</th>
          </tr>
        </thead>
        <tbody><!-- dinÃ¡mico --></tbody>
      </table>
    </section>
  </div>
</div>

<script>
  const razasPorEspecie = {
    'ğŸ¶ Perro': ['Labrador ğŸ¶','Pug ğŸ˜›','Chihuahua ğŸ’…','Pitbull ğŸ’ª'],
    'ğŸ± Gato': ['Persa ğŸ˜½','Siames ğŸ˜¸','Sphynx ğŸ±','Maine Coon ğŸ§¶'],
    'ğŸ° Conejo': ['Cabeza de leÃ³n ğŸ¦','Mini Lop ğŸ°','Angora âœ¨'],
    'ğŸ¦œ Ave': ['Periquito ğŸ¦','CacatÃºa ğŸµ','Loro ğŸ’š'],
    'ğŸ¹ HÃ¡mster': ['Sirio ğŸ§¡','Ruso â„ï¸','Roborovski âš¡'],
    'ğŸ¢ Tortuga': ['Orejas rojas ğŸ¢','Rusa ğŸŒ¿'],
    'ğŸ¦ Reptil': ['Iguana ğŸ¦','Gecko ğŸŠ','CamaleÃ³n ğŸŒˆ'],
    'ğŸ¦¡ HurÃ³n': ['Albino ğŸ¤','Mestizo ğŸ–¤'],
    'ğŸ´ Caballo': ['Pura Sangre ğŸ‡','Clydesdale ğŸ'],
    'ğŸ¹ Cuy': ['Peruano ğŸª¶','Abyssinian ğŸµï¸']
  };

  function abrirModalVacunas() {
    document.getElementById('modalVacunas').style.display = 'flex';
    cargarListaVacunas();
    onEspecieChange();
    cargarHistorial();
  }

  function cerrarModal(id) {
    document.getElementById(id).style.display = 'none';
    document.getElementById('formVacuna').reset();
    document.getElementById('raza').innerHTML = '<option>Seleccione especie primero</option>';
  }

  function onNombreMascotaChange() {
    const nombre = document.getElementById('nombreMascota').value.trim();
    if (!nombre) return;
    google.script.run.withSuccessHandler(info => {
      if (info.encontrado) {
        Object.assign(document.querySelector('#formVacuna'), {});
        document.getElementById('idCliente').value   = info.idCliente;
        document.getElementById('nombreDueno').value = info.nombreDueno;
        document.getElementById('idMascota').value   = info.idMascota;
        document.getElementById('edad').value        = info.edad;
        document.getElementById('sexo').value        = info.sexo;
        document.getElementById('peso').value        = info.peso;
        document.getElementById('especieSelect').value = info.especie;
        onEspecieChange();
        document.getElementById('raza').value = info.raza;
      } else {
        document.getElementById('nombreDueno').value = '';
      }
    }).verificarMascota(nombre);
  }

  function onEspecieChange() {
    const esp = document.getElementById('especieSelect').value;
    document.getElementById('especieOtro').style.display = esp==='Otro'?'block':'none';
    const sel = document.getElementById('raza');
    sel.innerHTML = '<option>Seleccione raza</option>';
    (razasPorEspecie[esp]||[]).forEach(r=> sel.add(new Option(r,r)));
    sel.add(new Option('Otro','Otro'));
    document.getElementById('razaOtro').style.display='none';
  }

  function onRazaChange() {
    document.getElementById('razaOtro').style.display =
      document.getElementById('raza').value==='Otro'?'block':'none';
  }

  function cargarListaVacunas() {
    const sel = document.getElementById('nombreVacuna');
    sel.innerHTML = '<option>Cargando...</option>';
    google.script.run.withSuccessHandler(vacs => {
      sel.innerHTML = '<option>Seleccione vacuna</option>';
      vacs.forEach(v => sel.add(new Option(v.nombre, v.nombre)));
    }).getVacunas();
  }

  function cargarHistorial() {
    // Implementa si tienes funciÃ³n que trae el historial
  }

  function guardarVacuna() {
    const data = Object.fromEntries(new FormData(document.getElementById('formVacuna')).entries());
    data.action = 'guardarVacuna';
    google.script.run.withSuccessHandler(resp => {
      if (resp.status==='success') {
        Toastify({ text: 'âœ… Guardado', gravity: 'top', backgroundColor: '#4caf50' }).showToast();
        cerrarModal('modalVacunas');
      } else {
        Toastify({ text: 'âŒ '+resp.message, gravity: 'top', backgroundColor: '#e74c3c' }).showToast();
      }
    }).guardarVacuna(data);
  }
</script>
