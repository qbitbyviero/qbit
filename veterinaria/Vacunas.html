<!-- MODAL VACUNAS -->
<div id="modalVacunas" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>💉 Registro de Vacunas</h2>
    
    <!-- 🐾 Datos de la Mascota -->
    <section>
      <h3>🐾 Información de la Mascota</h3>

      <!-- ID Cliente e ID Mascota ocultos -->
      <input type="hidden" id="idCliente" />
      <input type="hidden" id="idMascota" />

      <label for="nombreMascota">🐶 Nombre de Mascota:</label>
      <input type="text" id="nombreMascota" placeholder="Firulais, Michi..." onblur="onNombreMascotaChange()" />

      <label for="nombreDueno">👤 Dueño:</label>
      <input type="text" id="nombreDueno" placeholder="Cargando dueño..." readonly />

      <label for="especieSelect">🦴 Especie:</label>
      <select id="especieSelect" onchange="onEspecieChange()">
        <option value="">Seleccione especie</option>
        <option value="Perro 🐕">Perro 🐕</option>
        <option value="Gato 🐈">Gato 🐈</option>
        <option value="Conejo 🐇">Conejo 🐇</option>
        <option value="Ave 🐦">Ave 🐦</option>
        <option value="Hámster 🐹">Hámster 🐹</option>
        <option value="Tortuga 🐢">Tortuga 🐢</option>
        <option value="Reptil 🦎">Reptil 🦎</option>
        <option value="Hurón 🦡">Hurón 🦡</option>
        <option value="Caballo 🐴">Caballo 🐴</option>
        <option value="Cuy 🐹">Cuy 🐹</option>
        <option value="Otro">Otro</option>
      </select>
      <input type="text" id="especieOtro" placeholder="Especifique especie..." style="display:none; margin-top:5px;" />

      <label for="raza">🥇 Raza:</label>
      <select id="raza" onchange="onRazaChange()">
        <option value="">Seleccione especie primero</option>
      </select>
      <input type="text" id="razaOtro" placeholder="Especifique raza..." style="display:none; margin-top:5px;" />

      <label for="edad">🎂 Edad:</label>
      <input type="number" id="edad" min="0" placeholder="Años" />

      <label for="sexo">⚧️ Sexo:</label>
      <select id="sexo">
        <option value="Macho">Macho</option>
        <option value="Hembra">Hembra</option>
      </select>

      <label for="peso">⚖️ Peso (kg):</label>
      <input type="number" id="peso" min="0" step="0.1" placeholder="kg" />
    </section>

    <!-- 💉 Información de Vacunación -->
    <section>
      <h3>🧬 Detalles de Vacunación</h3>
      <label for="nombreVacuna">🧪 Vacuna:</label>
      <select id="nombreVacuna">
        <option value="">Cargando vacunas...</option>
      </select>

      <label for="fechaAplicacion">📅 Fecha de aplicación:</label>
      <input type="date" id="fechaAplicacion" />

      <label for="fechaRefuerzo">🔁 Fecha de refuerzo:</label>
      <input type="date" id="fechaRefuerzo" />

      <label for="veterinario">👨‍⚕️ Aplicado por:</label>
      <input type="text" id="veterinario" placeholder="Dr. Posh" />

      <label for="observaciones">📝 Observaciones:</label>
      <textarea id="observaciones" rows="3" placeholder="Ninguna reacción, necesita seguimiento..."></textarea>
    </section>

    <!-- 📋 Tabla de Vacunas -->
    <section>
      <h3>📊 Historial de Vacunación</h3>
      <table border="1" id="tablaVacunas">
        <thead>
          <tr>
            <!-- columnas definidas -->
          </tr>
        </thead>
        <tbody>
          <!-- filas dinámicas -->
        </tbody>
      </table>
    </section>

    <!-- ✅ Acciones -->
    <div class="acciones">
      <button onclick="guardarVacuna()">💾 Guardar Vacuna</button>
      <button onclick="cerrarModal('modalVacunas')">❌ Cerrar</button>
    </div>
  </div>
</div>

<script>
  // Mapa de especies y razas omitido para brevedad (igual al anterior)

  function onNombreMascotaChange() {
    const nombre = document.getElementById('nombreMascota').value;
    if (!nombre) return;
    // Llamar a servidor para obtener datos de cliente
    google.script.run.withSuccessHandler(data => {
      document.getElementById('idCliente').value = data.idCliente;
      document.getElementById('nombreDueno').value = data.nombreDueno;
      document.getElementById('idMascota').value = data.idMascota;
      // Si data incluye edad, sexo, peso, especie, raza, poblar campos
      if (data.edad) document.getElementById('edad').value = data.edad;
      if (data.sexo) document.getElementById('sexo').value = data.sexo;
      if (data.peso) document.getElementById('peso').value = data.peso;
      if (data.especie) {
        document.getElementById('especieSelect').value = data.especie;
        onEspecieChange();
        document.getElementById('raza').value = data.raza;
      }
    }).obtenerDatosCliente(nombre);
  }

  function guardarVacuna() {
    const payload = {
      idCliente: document.getElementById('idCliente').value,
      idMascota: document.getElementById('idMascota').value,
      nombreMascota: document.getElementById('nombreMascota').value,
      nombreDueno: document.getElementById('nombreDueno').value,
      especie: /* igual lógica Otro */ '',
      raza: '',
      edad: document.getElementById('edad').value,
      sexo: document.getElementById('sexo').value,
      peso: document.getElementById('peso').value,
      vacuna: document.getElementById('nombreVacuna').value,
      fechaAplicacion: document.getElementById('fechaAplicacion').value,
      fechaRefuerzo: document.getElementById('fechaRefuerzo').value,
      veterinario: document.getElementById('veterinario').value,
      observaciones: document.getElementById('observaciones').value
    };
    google.script.run.withSuccessHandler(res => {
      if (res.success) {
        alert('Vacuna guardada correctamente');
        cerrarModal('modalVacunas');
      } else {
        alert('Error: ' + res.error);
      }
    }).registrarVacuna(payload);
  }
</script>